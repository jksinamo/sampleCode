---
title: "Experiment 1"
author: "Joshua Sinamo"
date: "5/19/2020"
output: html_document
---

## Appendix Overview 
- External Requirements
- Finn and Servoss Rasch Model
- Finn and Servoss Rasch Visualization
- Alternative Rasch Model
- Alternative Rasch Visualization 
- Alternative Model Bootstrap - Initialization
- Alternative Model Bootstrap - Data Cleaning 
- Density Plot of Bootstrapped Security Indices

## External Requirements
```{r message=FALSE}
rm(list = ls())
library(lme4)     ; library(tidyr)
library(dplyr)    ; library(ggplot2) 
library(reshape2) ; library(Kendall)
library(parallel) ; library(gplots)
library(graphics) ; library(dendextend)

dat <- read.csv("./Downloads/project/els_02_12_byf3pststu_v1_0.csv")
```


```{r}
dataSecurity <- dat %>% dplyr::select("F1SCH_ID", "BYA38A", "BYA38B", "BYA38C", "BYA38D", "BYA38E", "BYA38F",
                                                "BYA38G", "BYA38H", "BYA38I", "BYA38J", "BYA38K", "BYA38L",
                                                "BYA38M", "BYA38N", "BYA38O", "BYA38P", "BYA39A", "BYA39B",
                                                "BYA39C", "BYA40A", "BYA40B", "BYA40C", "BYA40D", "BYA40E")
dataSecurity <- unique(dataSecurity[dataSecurity$F1SCH_ID > 1000 &
                                    dataSecurity$BYA38A != -8 & 
                                    dataSecurity$BYA38A != -7 &
                                    dataSecurity$BYA38A != -4, ])
names(dataSecurity)[2:25] <- substring(colnames(dataSecurity[,c(2:25)]), first = 4) 
names(dataSecurity)[1] <- "school"
rownames(dataSecurity) <- NULL
dataSecurity[dataSecurity == -9] <- NA
head(dataSecurity)
```


```{r}
heatData <- dataSecurity[,2:25] 
heatMatAll <- matrix(ncol=24, nrow=24)
for (i in 1:24){ 
  for (j in 1:24){
    heatMatAll[i,j] <- mean(heatData[,i] == heatData[,j], na.rm = TRUE)
  }
}
colnames(heatMatAll) <- colnames(heatData)
rownames(heatMatAll) <- colnames(heatData)

heatMatAll1 <- heatMatAll
heatMatAll1[upper.tri(heatMatAll1)] <- NA
ggplot(melt(heatMatAll1, na.rm= TRUE), aes(x = Var1, y = Var2, fill = value)) + 
  geom_raster() + labs(x = "", y = "", fill = "Proportion", 
                       title = "Proportion of Same Answers Between Questions (ELS: 2002)") + 
  scale_fill_distiller(palette = "Spectral") + 
  theme_bw() #  theme(panel.grid = element_blank())

dd <- dist(scale(t(heatData)), method = "euclidean")
hc <- as.dendrogram(hclust(dd, method = "average"))

dend <- t(heatData) %>% scale %>% dist %>% hclust("ward.D2") %>% as.dendrogram

dend %>% set("branches_k_color", k = 7) %>% 
         set("labels_cex", 1)           %>% 
         set("labels_color", k = 7)     %>%
         set("branches_lwd", 2)         %>%
         plot(main = "Dendrogram of ELS:2002 - Security Questions", 
              cex = 2, lwd = 10, srt = 45, horiz = TRUE, xlab = "Height")

abline(v = 6.525, lty = 2)
```

```{r cache=TRUE}
Sys.sleep(10)
```
```


## Finn and Servoss Rasch Model
```{r}
# FINN AND SERVOS SET OF QUESTIONS
FandS_set <- dataSecurity %>% select("school", "38C", "38D", "38H", "38G", "38N", "40A", "38F")

FandS_rasch <- FandS_set %>% tidyr::gather("item", "response", -school)
rasch_lmer_FandS <- glmer(response ~ item + (1|school), family = binomial, data = FandS_rasch)
```

## Alternative Rasch Model
```{r}
# MY ALTERNATIVE SET OF QUESTIONS
alt_set <- dataSecurity %>% select("school", "38H", "38K", "38C", "38E", "40E", "39C", "38J")

alt_rasch <- alt_set %>% tidyr::gather("item", "response", -school)
rasch_lmer_alt <- glmer(response ~ item + (1|school), family = binomial, data = alt_rasch)
```

```{r}
rasch_index_FandS <- coef(rasch_lmer_FandS)$school[,"(Intercept)"]
rasch_index_alt <- coef(rasch_lmer_alt)$school[,"(Intercept)"]

heatMat_FandS <- matrix(ncol=7, nrow=7)
heatMat_alt <- matrix(ncol=7, nrow=7)
for (i in 2:8){ 
  for (j in 2:8){
    heatMat_FandS[i - 1, j - 1] <- mean(FandS_set[,i] == FandS_set[,j], na.rm = TRUE)
    heatMat_alt[i - 1, j - 1]   <- mean(alt_set[,i] == alt_set[,j], na.rm = TRUE)
  }
}

plot(rasch_index_FandS, rasch_index_alt)

# mean proportion of same answers between F&S' variables
mean(heatMat_FandS[heatMat_FandS != 1], na.rm = TRUE)

# mean proportion of same answers between our variables
mean(heatMat_alt[heatMat_alt != 1], na.rm = TRUE)
```

```{r}
RMSE_ori       <- rep(NA, 20) ; RMSE_alt       <- rep(NA, 20)
AIC_ori        <- rep(NA, 20) ; AIC_alt        <- rep(NA, 20)
BIC_ori        <- rep(NA, 20) ; BIC_alt        <- rep(NA, 20)
RANEF_mean_ori <- rep(NA, 20) ; RANEF_mean_alt <- rep(NA, 20)
FIXEF_ori      <- rep(NA, 20) ; FIXEF_alt      <- rep(NA, 20)


for (i in 1:20){
  rasch_lmer_ori_NAGQ <- glmer(response ~ 0 + item + (1|school), family = binomial, data = FandS_rasch, nAGQ = i-1)
  rasch_lmer_alt_NAGQ <- glmer(response ~ 0 + item + (1|school), family = binomial, data = alt_rasch, nAGQ = i-1)
  
  RMSE_ori[i]  <- sqrt(mean(resid(rasch_lmer_ori_NAGQ)^2))  ; RMSE_alt[i]  <- sqrt(mean(resid(rasch_lmer_alt_NAGQ)^2))
  AIC_ori[i]   <- AIC(rasch_lmer_ori_NAGQ)                  ; AIC_alt[i]   <- AIC(rasch_lmer_alt_NAGQ)
  BIC_ori[i]   <- BIC(rasch_lmer_ori_NAGQ)                  ; BIC_alt[i]   <- BIC(rasch_lmer_alt_NAGQ)
  FIXEF_ori[i] <- list(fixef(rasch_lmer_ori_NAGQ))          ; FIXEF_alt[i] <- list(fixef(rasch_lmer_alt_NAGQ))
  RANEF_mean_ori[i] <- mean(ranef(rasch_lmer_ori_NAGQ)$school[["(Intercept)"]])     
  RANEF_mean_alt[i] <- mean(ranef(rasch_lmer_alt_NAGQ)$school[["(Intercept)"]])
}
```

```{r fig.height=3.5, fig.width=3.5}
assessment_data <- data.frame("measurement" = rep(c("RMSE", "AIC", "BIC", "Mean of RanEf"), each = 40),
           "model" = rep(c("F&S", "ALT"), each = 20, times = 4),
           "value" = c(c(RMSE_ori), c(RMSE_alt), c(AIC_ori), c(AIC_alt), c(BIC_ori), 
                     c(BIC_alt), c(RANEF_mean_ori), c(RANEF_mean_alt)),
           "nAGQ" = rep(seq(from = 0, to = 19), times = 8))

ggplot(data = assessment_data, aes(x = nAGQ, y = value, color = model)) + 
  geom_vline(xintercept = 4, color = "green") + 
  facet_grid(measurement~., scales = "free") + geom_line() + geom_point() + 
  labs(color    = "Model", caption = "Coefficients stabilizes at nAGQ >= 4",
       title    = "Selected Measurement vs # of Adaptive Gauss-Hermite Quadrature Points",
       subtitle =  "AIC, BIC, Mean of Ranef, and RMSE") + 
  theme(panel.margin     = unit(0.20, "lines"),
        panel.border     = element_rect(color = "black", fill = NA, size = 1), 
        strip.background = element_rect(color = "black", size = 1),
        plot.caption     = element_text(hjust = 0.5, size = 9),
        plot.title       = element_text(size = 11), 
        plot.subtitle    = element_text(size = 9))
```

```{r}
FIXEF_comb_ori<- FIXEF_ori[[1]]
FIXEF_comb_alt<- FIXEF_alt[[1]]
for(i in 2:20){
  FIXEF_comb_ori <- rbind(FIXEF_comb_ori, FIXEF_ori[[i]])
  FIXEF_comb_alt <- rbind(FIXEF_comb_alt, FIXEF_alt[[i]])
}

fixef_coef_ori0 <- data.frame(FIXEF_comb_ori); 
fixef_coef_ori0$nAGQ <- seq(0,19); fixef_coef_ori0$model <- "F&S"
fixef_coef_ori <- melt(fixef_coef_ori0, id.vars = c("nAGQ", "model"))
fixef_coef_alt0 <- data.frame(FIXEF_comb_alt); 
fixef_coef_alt0$nAGQ <- seq(0,19); fixef_coef_alt0$model <- "ALT"
fixef_coef_alt <- melt(fixef_coef_alt0, id.vars = c("nAGQ", "model"))

fixef_graph_data <- rbind(fixef_coef_ori, fixef_coef_alt)
fixef_graph_data$variable <- substring(fixef_graph_data$variable, first = 5)

library(grid)
library(directlabels)
library(RColorBrewer)
ggplot(data = fixef_graph_data, aes(x = nAGQ, y = value, colour = variable)) + 
  xlim(0,21) + geom_vline(xintercept = 1, color = "green") + 
  facet_grid(~model, scales = "free") + geom_line() + geom_point(size = 1) + 
  labs(color   = "Question", 
       title   = "Fixed Effects vs Number of Adaptive Gauss-Hermite Quadrature Points ",
       caption = "Fixed effect coefficients stabilizes at nAGQ = 1 (Laplace Approximation) or above") + 
  theme(plot.caption = element_text(hjust = 0.5)) + 
  geom_dl(aes(label = variable, x = 19.5), method = list(dl.combine("last.points"), cex = 0.7)) +
  scale_color_manual(values = colorRampPalette(brewer.pal(name="Dark2", n = 8))(12))
```

```{r}
# FINN AND SERVOS SET OF QUESTIONS
FandS_set <- dataSecurity %>% select("school", "38C", "38D", "38H", "38G", "38N", "40A", "38F")

FandS_rasch <- FandS_set %>% tidyr::gather("item", "response", -school)
rasch_lmer_FandS <- glmer(response ~ item + (1|school), family = binomial, data = FandS_rasch, nAGQ = 4)
```

## Alternative Rasch Model
```{r}
# MY ALTERNATIVE SET OF QUESTIONS
alt_set <- dataSecurity %>% select("school", "38H", "38K", "38C", "38E", "40E", "39C", "38J")

alt_rasch <- alt_set %>% tidyr::gather("item", "response", -school)
rasch_lmer_alt <- glmer(response ~ item + (1|school), family = binomial, data = alt_rasch, nAGQ = 4)
```

```{r}
cor.test(ranef(rasch_lmer_FandS)$school[["(Intercept)"]], 
         ranef(rasch_lmer_alt)$school[["(Intercept)"]], method = "kendal")
plot(ranef(rasch_lmer_FandS)$school[["(Intercept)"]], 
     ranef(rasch_lmer_alt)$school[["(Intercept)"]],
     xlab = "F&S", ylab = "Alternative",
     main = "Random Effect Indices")
```

## Alternative Model Bootstrap - Initialization

```{r}
ori_rasch_wide <- dataSecurity %>% dplyr::select(school, "38C", "38D", "38H", "38G", "38N", "40A", "38F")
alt_rasch_wide <- dataSecurity %>% dplyr::select(school, "38H", "38K", "38C", "38E", "40E", "39C", "38J")

resamplerWide = function(set){
  whichrows <- sample(1L:nrow(set), nrow(set), replace = TRUE)
  set[whichrows,] %>% tidyr::gather("item", "response", -school)
}
```

```{r warning=FALSE, cache=TRUE}
ori_rasch <- ori_rasch_wide %>% tidyr::gather("item", "response", -school)
rasch_lmer <- glmer(response ~ item + (1 | school), 
                             family = binomial, data = ori_rasch)#, nAGQ = 0)
```

```{r}
logit_coefs_LMER = function(bootspl){
  refitted.mod <- update(rasch_lmer, data = bootspl)
  ranef(refitted.mod)
}

bootreps <- 500
bootstats_ori  <- bootreps %>% replicate(resamplerWide(ori_rasch_wide) %>% logit_coefs_LMER())
#bootstats_alt <- bootreps %>% replicate(resamplerWide(alt_rasch_wide) %>% logit_coefs_LMER())
```

```{r cache=TRUE}
knitr::opts_chunk$set(echo = TRUE)
ori_rasch_wide <- dataSecurity %>% dplyr::select(school, "38C", "38D", "38H", "38G", "38N", "40A", "38F")
alt_rasch_wide <- dataSecurity %>% dplyr::select(school, "38H", "38K", "38C", "38E", "40E", "39C", "38J")

ori_rasch <- ori_rasch_wide %>% tidyr::gather("item", "response", -school)
rasch_lmer <- glmer(response ~ item + (1 | school), 
                             family = binomial, data = ori_rasch, nAGQ = 4)
```


```{r, results = "hide"}
ori_rasch_wide <- dataSecurity %>% dplyr::select(school, "38C", "38D", "38H", "38G", "38N", "40A", "38F")
alt_rasch_wide <- dataSecurity %>% dplyr::select(school, "38H", "38K", "38C", "38E", "40E", "39C", "38J")

ori_rasch <- ori_rasch_wide %>% tidyr::gather("item", "response", -school)
rasch_lmer <- glmer(response ~ item + (1 | school), 
                             family = binomial, data = ori_rasch, nAGQ = 4)

resamplerWide = function(i, questionSet){
  whichrows <- sample(1L:nrow(questionSet), nrow(questionSet), replace = TRUE)
  bootspl <- questionSet[whichrows,] %>% tidyr::gather("item", "response", -school)
  refitted.mod <- update(rasch_lmer, data = bootspl)
  ranef(refitted.mod)
}

cl <- makeCluster(detectCores()-1)
clusterEvalQ(cl, c(library(lme4), library(dplyr), library(tidyr)))
clusterSetRNGStream(cl)
clusterExport(cl, c("ori_rasch_wide", "alt_rasch_wide", "rasch_lmer"))

bootreps <- 500
start.time1 <- Sys.time()
bootstats_ori  <- parSapply(cl, 1:bootreps, FUN = resamplerWide, questionSet = ori_rasch_wide)
end.time1 <- Sys.time(); end.time1 - start.time1

start.time2 <- Sys.time()
bootstats_alt  <- parSapply(cl, 1:bootreps, FUN = resamplerWide, questionSet = alt_rasch_wide)
end.time2 <- Sys.time(); end.time2 - start.time2

stopCluster(cl)
```

```{r}
#bootstats_ori  <- parSapply(cl, 1:500, function(i){
#  #resamplerWide(ori_rasch_wide)
#  whichrows    <- sample(1L:nrow(ori_rasch_wide), nrow(ori_rasch_wide), replace = TRUE)
#  bootspl      <- ori_rasch_wide[whichrows,] %>% tidyr::gather("item", "response", -school)
#  refitted.mod <- update(rasch_lmer, data = bootspl)
#  ranef(refitted.mod)
#  })

#bootstats_alt <- parSapply(cl, 1:500, function(i){
#  #resamplerWide(alt_rasch_wide)
#  whichrows <- sample(1L:nrow(alt_rasch_wide), nrow(alt_rasch_wide), replace = TRUE)
#  bootspl <- alt_rasch_wide[whichrows,] %>% tidyr::gather("item", "response", -school)
#  refitted.mod <- update(rasch_lmer, data = bootspl)
#  ranef(refitted.mod)
#  })
```


## Alternative Model Bootstrap - Data Cleaning 
```{r}
# "pasting" other bootstrap results into the data
dataCleaning <- function(bootstrappedData) { 
  
  lmerBootContainer  <- data.frame(bootstrappedData[1])
  lmerBootContainer$index <- rownames(lmerBootContainer)
  lmerBootContainer$rep  <- 1
  colnames(lmerBootContainer)[1] <- "value"
  for (i in 2:bootreps){
    lmerBootAdd <- data.frame(bootstrappedData[i])
    lmerBootAdd$index <- rownames(lmerBootAdd)
    lmerBootAdd$rep <- i
    colnames(lmerBootAdd)[1] <- "value"
    lmerBootContainer <- rbind(lmerBootContainer, lmerBootAdd)
  }

  # statistics for the bootstrap coefficients
  lmerBoot  <- lmerBootContainer %>% dplyr::group_by(index) %>% 
                  dplyr::summarise("mean" = mean(value, na.rm = TRUE),
                                   "sampsize" = n(),
                                   "lowerBound" = mean - 2*sd(value, na.rm = TRUE)/sqrt(sampsize),
                                   "upperBound" = mean + 2*sd(value, na.rm = TRUE)/sqrt(sampsize),
                                   "length" = upperBound - lowerBound)
  return(list(lmerBootContainer, lmerBoot))
}

ori_boot <- dataCleaning(bootstats_ori)
alt_boot <- dataCleaning(bootstats_alt) 
```

## Density Plot of Bootstrapped Security Indices
```{r}
#plot(density(lmerBoot$mean), "Distribution of School Security Indices")
library(ggpubr)
full_boot_ori <- ori_boot[[1]]
full_boot_alt <- alt_boot[[1]]

par(mfrow = c(2,2))
ggdensity(full_boot_ori[, "value"])
ggdensity(full_boot_alt[, "value"])
ggdensity(full_boot_ori[full_boot_ori$index == "1031", "value"])
ggdensity(full_boot_alt[full_boot_alt$index == "1031", "value"])
#ggqqplot(full_boot_ori[full_boot_ori$index == "id1061", "value"])
#ggdensity(full_boot_alt[full_boot_alt$index == "id1061", "value"])
#ggqqplot(full_boot_alt[full_boot_alt$index == "id1061", "value"])

```
```{r}
par(mfrow = c(2,2))
ggdensity(full_boot_ori[full_boot_ori$index == "id1011", "value"])
ggqqplot(full_boot_ori[full_boot_ori$index == "id1011", "value"])
ggdensity(full_boot_alt[full_boot_alt$index == "id1011", "value"])
ggqqplot(full_boot_alt[full_boot_alt$index == "id1011", "value"])
```
```{r}
par(mfrow = c(2,2))
ggdensity(full_boot_ori[full_boot_ori$index == "id1031", "value"])
ggqqplot(full_boot_ori[full_boot_ori$index == "id1031", "value"])
ggdensity(full_boot_alt[full_boot_alt$index == "id1031", "value"])
ggqqplot(full_boot_alt[full_boot_alt$index == "id1031", "value"])
#shapiro.test(lmerBootContainer[lmerBootContainer$index == "id1061", "value"])
```


